- name: 'apt update && upgrade'
  apt:
      update_cache: yes
      upgrade: safe


- name: 'install apache'
  apt:
      name: apache2
      state: present

- name: 'copy apache config'
  register: new_apache_config
  copy:
      src: apache2/conf-available/
      dest: /etc/apache2/conf-available/

- name: 'enable apache config'
  file:
      src: ../conf-available/zuul.conf
      dest: /etc/apache2/conf-enabled/zuul.conf
      state: link

- name: 'reload apache'
  service:
      name: apache2
      state: restarted
  when: new_apache_config.changed


- name: 'install pip'
  apt:
      name: python-pip
      state: present

- name: 'install zuul using pip'
  pip:
      name: zuul
      version: 2.6.0

- name: 'install gearman using pip'
  pip:
      name: gearman
      version: 2.0.2


- name: 'copy zuul config files'
  register: new_zuul_config
  copy:
      src: zuul/
      dest: /etc/zuul/

- name: 'retrieve ip address of zuul host'
  set_fact:
     zuul_host: '{{ ansible_default_ipv4.address }}'

- name: 'generate zuul.conf from template'
  template:
     src: zuul.conf.j2
     dest: /etc/zuul/zuul.conf

- name: 'copy zuul .service files'
  copy:
      src: services/
      dest: /lib/systemd/system/

- name: 'add zuul group'
  group:
      name: zuul
      state: present

- name: 'add zuul user'
  user:
      name: zuul
      group: zuul

- name: 'create zuul directories in /var'
  file:
      path: '{{ item }}'
      state: directory
      owner: zuul
      group: zuul
  with_items:
      - /var/lib/zuul
      - /var/lib/zuul/ssh
      - /var/lib/zuul/git
      - /var/log/zuul

- name: 'copy key for accessing gerrit'
  copy:
      content: '{{ gerrit_keys[gerrit_keyname] }}'
      dest: /var/lib/zuul/ssh/id_rsa

- name: 'restart zuul services (when config changed)'
  service:
      name: '{{ item }}'
      state: restarted
  with_items: &zuul_services
      - zuul-server
      - zuul-merger
  when: new_zuul_config.changed

- name: 'enable zuul services'
  service:
      name: '{{ item }}'
      enabled: yes
      state: started
  with_items: *zuul_services
